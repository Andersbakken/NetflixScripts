#!/bin/sh

GITCOMMIT=
P4COMMIT=
MESSAGE=
TEST=
JIRA=

INTERACTIVE=no
COMMENT=maybe
RESOLVE=maybe
CREATE=no

if ! which jira >/dev/null 2>&1; then
   echo "Cannot find jira commandline!"
   exit 2
fi

usage() {
  echo "Usage: $1 [args] [git-commit]"
  echo
  echo "Args:"
  echo " --comment, -c <msg> : Send <msg> instead of calculated from commit message"
  echo " --interactive, -i   : Ask before commenting/resolving"
  echo " --resolve, -r       : Resolve JIRA ticket as well was commenting"
  echo " --jira, -j <ticket> : Use <ticket> instead of calculated from commit message"
  echo " --p4 <p4-commit>    : Use <p4-commit> instead of calculating from commit message"
  echo
  echo "If no [git-commit] is provided then the last commit from $(whoami) will be used instead"
  exit 3
}

while [ "$#" -gt 0 ]; do
   OPT="$1"
   case $OPT in
   --test|-test) TEST="echo" ;;
   --create|-create) CREATE=yes ;;
   --comment|-c|-comment) COMMENT=yes ;;
   --interactive|-i) INTERACTIVE=yes ;;
   --resolve|-r|-resolve) RESOLVE=yes; COMMENT=yes ;;
   --message|-m) shift; MESSAGE="$1"; COMMENT=yes ;;
   --jira|-j) shift; JIRA="$1" ;;
   --p4|-p4) shift; P4COMMIT="$1" ;;
   -help) usage $0 ;;
   *)
      if [ -z "$GITCOMMIT" ]; then
          GITCOMMIT="$1"
      elif [ -z "$P4COMMIT" ]; then
          P4COMMIT="$1"
      else
          usage $0
      fi ;;
   esac
   shift
done

[ -z "$GITCOMMIT" ] && GITCOMMIT=`git log --author=$(whoami) -n1 --pretty=format:"%h"`
[ -z "$GITCOMMIT" ] && GITCOMMIT="HEAD"
echo "Git: $GITCOMMIT"
[ -z "$P4COMMIT" ] && P4COMMIT=`git p4 change --git "$GITCOMMIT" 2>/dev/null | awk '{print $4}'`

if [ -z "$JIRA" ]; then
  DESCRIPTION=
  [ -n "$P4COMMIT" ] && DESCRIPTION=`p4 describe -s $P4COMMIT | grep $'^\t' | sed "s,^\s*,,g"`
  [ -z "$DESCRIPTION" ] && DESCRIPTION=`git show --quiet --pretty=format':%s' "$GITCOMMIT"`
  if [ -z "$DESCRIPTION" ]; then
    echo "Description not found!"
  elif echo "$DESCRIPTION" | grep '^\[[^ ]\+-[0-9]\+\] ' >/dev/null 2>&1; then
    JIRA=`echo "$DESCRIPTION" | sed 's,^\[\([^ ]\+-[0-9]\+\)\].*,\1,g'`
  elif echo "$DESCRIPTION" | grep '^[^ ]\+-[0-9]\+: ' >/dev/null 2>&1; then
   JIRA=`echo "$DESCRIPTION" | sed 's,^\([^ ]\+-[0-9]\+\): .*,\1,g'`
  fi
fi
if [ "$CREATE" = "yes" ]; then
  #project
  JIRA_PROJECT=""
  [ -n "$JIRA" ] && JIRA_PROJECT=`echo $JIRA | cut -d'-' -f1`
  if [ -z "$JIRA_PROJECT" ]; then
      echo "=================================================="
      echo -n "Project: "
      read JIRA_PROJECT
  fi
  if [ -z "$JIRA_PROJECT" ]; then
      echo "Must supply a PROJECT!"
      exit 1
  fi
  #summary
  echo "=================================================="
  echo "Default Summary: $DESCRIPTION"
  echo -n "Summary: "
  read JIRA_SUMMARY
  [ -z "$JIRA_SUMMARY" ] && JIRA_SUMMARY="$DESCRIPTION"
  #description
  echo "=================================================="
  echo -n "Description: "
  read JIRA_DESCRIPTION

  JIRA_CREATED=
  if [ -n "$TEST" ]; then
      $TEST jira create -p \"$JIRA_PROJECT\" -s \"$JIRA_SUMMARY\" -d \"$JIRA_DESCRIPTION\" -e \"\"
  else
      JIRA_CREATED=`jira create -p "$JIRA_PROJECT" -s "$JIRA_SUMMARY" -d "$JIRA_DESCRIPTION" -e "" | tail -1`
      if echo "$JIRA_CREATED" | grep 'Created issue' >/dev/null 2>&1; then
          JIRA_CREATED=`echo $JIRA_CREATED | sed "s,^Created issue ,,"`
      else
          JIRA_CREATED=
      fi
  fi
  echo "Created: $JIRA_CREATED"
  #DESCRIPTION_FILE=`mktemp`
  #if [ -z "$JIRA" ]; then
  #    echo "$DESCRIPTION" | sed -e "s,^ *,,g" -e "s,$JIRA,$CREATED_JIRA,g" >"$DESCRIPTION_FILE"
  #else
  #    echo "[$JIRA_CREATED] $DESCRIPTION" | sed -e "s,^ *,,g" >"$DESCRIPTION_FILE"
  #fi
  #[ -n "$TEST" ] && cat "$DESCRIPTION_FILE"
  #$TEST git commit -c "$GIT_COMMIT" -F "$DESCRIPTION_FILE"
elif [ -z "$JIRA" ]; then
  #echo "Unable to determine JIRA ticket!"
  true
else
  echo "Jira: $JIRA"
  $TEST jira cat "$JIRA"
  if [ "$INTERACTIVE" = "yes" ]; then
      if [ "$COMMENT" = "maybe" ]; then
          COMMENT=no
          echo -n "Comment? "
          read input
          if [ "$input" = "r" ]; then
              COMMENT=yes
              [ "$RESOLVE" = "maybe" ] && RESOLVE=yes
          elif [ "$input" = "y" ] || [ "$input" = "yes" ]; then
              COMMENT=yes
          fi
      fi
      if [ "$RESOLVE" = "maybe" ]; then
          RESOLVE=no
          echo -n "Resolve? "
          read input
          if [ "$input" = "y" ] || [ "$input" = "yes" ]; then
              RESOLVE=yes
          fi
      fi
  fi
  if [ "$COMMENT" = "yes" ]; then
    if [ -n "$MESSAGE" ]; then
      $TEST jira comment "$JIRA" "$MESSAGE"
    elif [ -n "$P4COMMIT" ] && ! jira comments "$JIRA" | grep $P4COMMIT >/dev/null 2>&1; then
      $TEST jira comment "$JIRA" "[Changelist: $P4COMMIT|http://perforce.netflix.com/$P4COMMIT?ac=10] $DESCRIPTION"
    fi
  fi
  if [ "$RESOLVE" = "yes" ]; then
    $TEST jira resolve "$JIRA"
  fi
fi
exit 0
